<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>My Sublime Text Clone Web</title>
    <style>
        body {
            font-family: 'Courier New', Courier, monospace;
            margin: 0;
            padding: 0;
            overflow: hidden;
            background-color: #272822;
            color: #F8F8F2;
        }
        body *{
             background-color: rgba(0, 0, 0, 0);
            /*font-family: 'Courier New', Courier, monospace;*/
        }

        #code-wrapper {
            display: flex;
            flex-direction: row;
        }

        #line-numbers {
            display: flex;
            flex-direction: column;
            margin-top: 4px;
            width: 40px;
            text-align: center;
        }

        .line-number {
            color: #888;
            line-height: 20px;
        }

        textarea {
            width: calc(100% - 30px);
            height: 100vh;
            /*padding: 10px;*/
            /*box-sizing: border-box;*/
            color: #F8F8F2;
            border: none;
            outline: none;
            font-size: 16px;
            line-height: 20px;
            resize: none;
            white-space: pre;
            overflow: hidden;

            color: rgba(100, 100, 100, 1);
            caret-color: white; /*#F8F8F2;*/
        }

          #highlighter{
          position: absolute;
          top: 3px;
          left:42px;
          font-size: 16px;
          line-height: 20px;
          color: #F8F8F2;;
          /*color: red;*/
          user-select: none;
          pointer-events: none;
         
          }
        .highlight{
            color: orange;
        }
    </style>
</head>
<body>
    <div id="code-wrapper">
        <div id="line-numbers"></div>
        <textarea id="textarea" oninput="auto_grow(this)" spellcheck="false"></textarea>
    </div>
    <div id="highlighter"></div>


    <script>
        const textarea = document.getElementById('textarea');
        const lineNumbers = document.getElementById('line-numbers');
        const highlighter = document.getElementById("highlighter");

               // console.log(textarea);
         var computedStyle = window.getComputedStyle(textarea);
         // console.log(computedStyle);
          var fontFamily = computedStyle.fontFamily;
         // console.log(fontFamily);

         highlighter.style.fontFamily = fontFamily;




          function colorizeTextArea() {
            var text = textarea.value;
            var highlightedText = '';
            for (var i = 0; i < text.length; i++) {
              if (!(/[a-zA-Z]/).test(text[i])) {
                highlightedText += '<span style="color: red;">' + text[i] + '</span>';
              } else {
                highlightedText += text[i];
              }
            }
            // highlightedText = highlightedText.replace(new RegExp('\r?\n','g'), '<br />');
            highlightedText = highlightedText.replace(/\n/g, '<br>').replace(/\t/g, '<pre style="display:inline;">&#9;</pre>');
            highlighter.innerHTML = highlightedText;
          }
          colorizeTextArea();
          document.getElementById("textarea").addEventListener("input", colorizeTextArea);

        function updateLineNumbers() {
            const linesNeeded = textarea.value.split('\n').length;
            console.log(linesNeeded);

            const difference = linesNeeded - lineNumbers.children.length;
            if (difference > 0){

            for (let i = lineNumbers.children.length+1; i <= linesNeeded; i++) {
                lineNumbers.innerHTML += `<div class="line-number">${i}</div>`;
            }
        

            }else if (difference < 0){
                  for (let i = 0; i < Math.abs(difference); i++) {
            lineNumbers.removeChild(lineNumbers.lastChild);
        }
            }
        }

        function auto_grow(element) {
          element.style.height = "5px";
          element.style.height = (element.scrollHeight) + "px";
        }

        function getLineIndexOfCaret(caretPosition) {
    var textBeforeCaret = textarea.value.substring(0, caretPosition);
    var lineIndex = textBeforeCaret.split('\n').length;
    return lineIndex-1;
}

function getSelectionIndexAtLine(lineIndex, isStartOfLine) { 
    var lines = textarea.value.split('\n');
    if (lineIndex < 0 || lineIndex >= lines.length) {
        console.error('Invalid line index');
        return -1;
    }

    var characterCount = 0;
    for (var i = 0; i < lineIndex; i++) {
        characterCount += lines[i].length+1; // Add 1 for the newline character
    }

    if (isStartOfLine == false) {
        characterCount += lines[lineIndex].length; 
    }

    return characterCount;
}
    document.addEventListener('keydown', function(event) {

        if (event.ctrlKey || event.metaKey) {
                event.preventDefault();
            }

            if (event.key === "Tab") {

                console.log("tabbed");
                event.preventDefault();
                let start = textarea.selectionStart;
                let end = textarea.selectionEnd;

                textarea.value = textarea.value.substring(0, start) + "\t" + textarea.value.substring(end);
                textarea.selectionStart = textarea.selectionEnd = start + 1;
            }


    if (event.ctrlKey) {
        var selectionStart = textarea.selectionStart;
        var selectionEnd = textarea.selectionEnd;
        switch(event.key) {
            case 's':
                saveTextFile();
                break;
            case 'a':
                textarea.select();
                break;
            case 'c':
                if (selectionStart !== selectionEnd) {
                    var selectedText = textarea.value.substring(selectionStart, selectionEnd);
                    navigator.clipboard.writeText(selectedText);
                }
                break;
            case 'x':
                if (selectionStart !== selectionEnd) {
                    var selectedText = textarea.value.substring(selectionStart, selectionEnd);
                    navigator.clipboard.writeText(selectedText);
                    textarea.value = textarea.value.substring(0, selectionStart) + textarea.value.substring(selectionEnd);
                }
                break;
            case 'v':
                navigator.clipboard.readText()
                    .then(clipText => {
                        textarea.setRangeText(clipText, selectionStart, selectionEnd, 'end');
                    });
                break;


            case 'd':
                if (event.altKey) {
                    deleteLine(selectionStart, textarea);
                } else {
                    duplicateLine(selectionStart, textarea);
                }
                break;
            default:
                break;
        }
    }
});

function duplicateLine(cursorPos, textarea) { // TODO FIX RELOADING VISUALS;  Calculated new cursor at the end of new line.
    var textLines = textarea.value.split('\n');
    var currentLineIndex = textarea.value.substr(0, cursorPos).split('\n').length - 1;
    var currentLine = textLines[currentLineIndex];
    textLines.splice(currentLineIndex + 1, 0, currentLine);
    textarea.value = textLines.join('\n');
    const newCursorPos = cursorPos;
    textarea.setSelectionRange(newCursorPos, newCursorPos);
    textarea.dispatchEvent(new Event('input'));

}

function deleteLine(cursorPos, textarea) {
    var textLines = textarea.value.split('\n');
    var currentLineIndex = textarea.value.substr(0, cursorPos).split('\n').length - 1;
    textLines.splice(currentLineIndex, 1);
    textarea.value = textLines.join('\n');
    const newCursorPos = cursorPos;
    textarea.setSelectionRange(newCursorPos, newCursorPos);
    textarea.dispatchEvent(new Event('input'));
}


function saveTextFile() {
    var textToSave = textarea.value;
    
    var blob = new Blob([textToSave], {type: 'text/plain'});
    var a = document.createElement('a');
    a.download = 'text.txt';
    a.href = window.URL.createObjectURL(blob);
    a.style.display = 'none';
    document.body.appendChild(a);
    a.click();
    window.URL.revokeObjectURL(a.href);
    document.body.removeChild(a);
}


    
        let pos = -1;
        function checkcaret() { // fix line focus after last line was deleted 
            const newPos = textarea.selectionStart;
            const oldLineIndex = getLineIndexOfCaret(pos);
            const lineIndex = getLineIndexOfCaret(newPos);
            console.log(newPos)
        
        if (lineIndex !== oldLineIndex) {
            const lineStart = getSelectionIndexAtLine(lineIndex,true);
            const lineEnd = getSelectionIndexAtLine(lineIndex,false);
            console.log(`line:${lineIndex+1}  curr:${newPos} start:${lineStart} end:${lineEnd}   ${lineIndex} !==  ${oldLineIndex} `);
            var oldLineNumberElement = lineNumbers.children[oldLineIndex];
            var currentLineNumberElement = lineNumbers.children[lineIndex];
            oldLineNumberElement.classList.remove("highlight");
            currentLineNumberElement.classList.add("highlight");
            pos = newPos;
          }
        }


        function delayedCheck() {
            
            setTimeout(function() {
                checkcaret()
    },1); 
        }



        textarea.focus();
        textarea.addEventListener('keydown', delayedCheck); 
        textarea.addEventListener('click', checkcaret); // Every character written
        // textarea.addEventListener('keyup', checkcaret); // Every character written
        // textarea.addEventListener('keydown', checkcaret); // Every character written
        // textarea.addEventListener('keypress', checkcaret); // Every character written
        // textarea.addEventListener('mousedown', checkcaret); // Click down
        // textarea.addEventListener('touchstart', checkcaret); // Mobile
        // textarea.addEventListener('input', checkcaret); // Other input events
        // textarea.addEventListener('paste', checkcaret); // Clipboard actions
        // textarea.addEventListener('cut', checkcaret);
        // textarea.addEventListener('mousemove', checkcaret); // Selection, dragging text
        // textarea.addEventListener('select', checkcaret); // Some browsers support this event
        // textarea.addEventListener('selectstart', checkcaret); // Some browsers support this event

        textarea.addEventListener("input", function() {auto_grow(this);});
        textarea.addEventListener('input', updateLineNumbers);
        window.addEventListener('DOMContentLoaded', updateLineNumbers);
    </script>
</body>
</html>
